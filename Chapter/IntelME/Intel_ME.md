# Intel ME 相关操作

##查看ME Power命令
向ME发送指令可以有两种方式，如下所示，一种使用send command指令，一种直接指定bus和slaver address，推荐使用第二种
```
ipmitool -I lanplus -H BMCIP -U admin -P admin raw 0x06 0x34 0x46 0x2c 0xb8 0x1c 0x20 0x10 0xc8 0x57 0x01 0x00 0x01 0x00 0x00 0xaf

ipmitool -I lanplus -H BMCIP -U admin -P admin -b 6 -t 0x2c raw 0x2e 0xc8 0x57 0x01 0x00 0x01 0x00 0x00
```

##查看CPU/MEM CUPS命令
```
ipmitool -I lanplus -H BMCIP -U admin -P admin -b 6 -t 0x2c raw 0x04 0x2d 0xbe(0xc0)
```
be为CPU的，c0为MEM的

返回值fc 40 c0     第一位就是对应的占用率,换算方式为（0xfc/0xff）*100


##设置ME Power Policy的另外一种方式

注意：参照Node Manager 4.0文档，domain ID在前，policy ID在后,并且只有在Policy Control、Domain Control、Global Control同时enable时候才能生效

domain ID：

=00h – Entire platform.

=01h – CPU subsystem.

=02h – Memory subsystem.

=03h – HW Protection*.

=04h – High Power I/O subsystem

1.内存功耗读取：
```
ipmitool -b 6 -t 0x2c raw 0x2e 0xc8 0x57 0x01 0x00 0x01 0x02 0x00
```

2.设置内存功耗（Domain ID在前，Policy ID在后）

  1) Disable Node Manager Policy Control
  ```
  ipmitool -b 6 -t 0x2c raw 0x2e 0xc0 0x57 0x01 0x00 0x00 0x02 0x04
  ```

  2)Create NM Policy
  ```
  ipmitool -b 6 -t 0x2c raw 0x2e 0xc1 0x57 0x01 0x00 0x02 0x04 0x10 0x00 $WATT 0x00 0xe8 0x03 0x00 0x00 $WATT 0x00 0x01 0x00
  ```

  3)Enable Node Manager Policy
  ```
  ipmitool -b 6 -t 0x2c raw 0x2e 0xc0 0x57 0x01 0x00 0x05 0x02 0x04    Enable Policy Control
  ipmitool -b 6 -t 0x2c raw 0x2e 0xc0 0x57 0x01 0x00 0x03 0x02 0x04    Enable Domain Control
  ipmitool -b 6 -t 0x2c raw 0x2e 0xc0 0x57 0x01 0x00 0x01 0x02 0x04    Enable Global Control
  ```

3.查询Policy ID的使能情况
  ```
  ipmitool -b 6 -t 0x2c raw 0x2e 0xc2 0x57 0x01 0x00 0x02 0x04
  ```
  返回值查看Byte5,前四位表示各种策略的enable情况，后四位表示Domain ID


##刷新BIOS前后的动作

根据Node Manager 4.0文档 第24页内容：

刷新前下0x01命令，刷新后下0x02命令

DFh命令

  01 ME进入Recovery Mode的指令
  ```
  ipmitool -I -H -U -P -t 0x2c -b 6 -t 0x2c raw 0x2e  0xdf 0x57 0x01 0x00 0x01
  ipmitool -I -H -U -P raw 0x06 0x34 0x46 0x2c 0xb8 0x1c 0x20 0x10 0xdf 0x57 0x01 0x00 0x01
  ```

  02 ME离开Recovery Mode并重启的命令
  ```
  ipmitool -I -H -U -P -t 0x2c -b 6 -t 0x2c raw 0x2e  0xdf 0x57 0x01 0x00 0x02
  ipmitool -I -H -U -P raw 0x06 0x34 0x46 0x2c 0xb8 0x1c 0x20 0x10 0xdf 0x57 0x01 0x00 0x02
  ```

  03 查询ME状态指令
  ```
  ipmitool -I lanplus -H -U -P -t 0x2c -b 0x06 raw 0x06 0x04    ME selftest result
  ```


##ME Restart与ME Global Reset

ME Restart  这个命令有时候比ME Global Reset好用,0x02表示回复ME default value
```
ipmitool -b 6 -t 0x2c raw 0x2e 0xdf 0x57 0x01 0x00 0x02
```


##设置ME Power Policy失败的一种原因

设置ME Power Policy的时候有时候会设置不进去，发送ME Power Policy命令返回0x84错误码，表示Power Limit out of range

这个是由于ME存在设定功耗的最小值与最大值，这个最小值与最大值可以通过命令获得，命令如下
```
ipmitool -b 6 -t 0x2c raw 0x2e 0xc9 0x57 0x01 0x00 0x01 0x10
```
其中倒数第二位表示domain ID；Byte 5[3:0]用于控制获得的值表示的含义，[6:4] – Policy Type表示电源的某种工作模式，默认使用0x10


返回值中的

Byte 6:7 Max Power/Thermal/Time After Reset    

Byte 8:9 – Min Power/Thermal/Time After Reset

当指令中的功耗值不在这个范围内就会产生0x84的错误码


##获取ME中RTC的时间

获取ME中RTC的时间指令，回复的指令为LSB
```
ipmitool -I -H -U -P -b 6 -t 0x2c raw 0x0a 0x48
```

最大值和最小值可以通过0xCB这条命令设置，注意，设置后可能导致ME限定功耗功能不能使用，一定慎用
